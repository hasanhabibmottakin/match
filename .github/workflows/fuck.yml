name: Auto Update Stream API

on:
  schedule:
    - cron: "*/20 * * * *"    
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-api:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Run scraper (Corrected Indentation & Debugging Added)
        env:
          BASE_LISTING_URL: ${{ secrets.BASE_LISTING_URL }}
          BASE_STREAM_URL: ${{ secrets.BASE_STREAM_URL }}
        run: |
          # --- YAML Fix: All lines below are indented 4 spaces to be part of 'run' ---
          php <<'PHP'
          <?php
          function xor_decrypt($data_base64, $key) {
              $decoded = base64_decode($data_base64);
              $output = '';
              $keylen = strlen($key);
              for ($i = 0; $i < strlen($decoded); $i++) {
                  $output .= chr(ord($decoded[$i]) ^ ord($key[$i % $keylen]));
              }
              return $output;
          }
          
          function fetch_and_decrypt_stream_info($url, $content_id) {
              echo "â†’ Processing ID: $content_id at $url\n";
              $opts = [
                  "http" => [
                      "header" => "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36\r\n", // More robust User-Agent
                      "timeout" => 15 // Increased timeout slightly
                  ]
              ];
              $context = stream_context_create($opts);
              $html = @file_get_contents($url, false, $context);
              if (!$html) {
                  echo "  [ERROR] Failed to fetch $url. (Check URL or Firewall/Rate Limiting)\n";
                  return null;
              }
          
              preg_match('/const decryptionKey = "(.*?)";/', $html, $keyMatch);
              preg_match('/let encrypted = "(.*?)";/', $html, $encMatch);
              if (empty($keyMatch[1]) || empty($encMatch[1])) {
                  echo "  [WARN] Missing key/encrypted data. (Page structure may have changed)\n";
                  return null;
              }
              echo "  [DEBUG] Found Key and Encrypted Data.\n";
          
              $decrypted = xor_decrypt($encMatch[1], $keyMatch[1]);
              preg_match("/const mpdUrl = '(.*?)';/", $decrypted, $mpd);
              preg_match("/const kid = '(.*?)';/", $decrypted, $kid);
              preg_match("/const key = '(.*?)';/", $decrypted, $keyv);
          
              if (empty($mpd[1]) || empty($kid[1]) || empty($keyv[1])) {
                  echo "  [WARN] Missing mpd/kid/key info in decrypted data.\n";
                  echo "  [DEBUG] Decrypted content snippet: " . substr($decrypted, 0, 100) . "...\n"; 
                  return null;
              }
              echo "  [DEBUG] Decryption successful. Found all required info.\n";

              return [
                  "mpdUrl" => $mpd[1],
                  "kid" => $kid[1],
                  "key" => $keyv[1]
              ];
          }
          
          function get_channel_ids($base_listing_url) {
              echo "[INFO] Fetching listing: $base_listing_url\n";
              $opts = [
                  "http" => [
                      "header" => "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36\r\n",
                      "timeout" => 15
                  ]
              ];
              $context = stream_context_create($opts);
              $html = @file_get_contents($base_listing_url, false, $context);
              if (!$html) {
                  echo "[FATAL] Failed to fetch listing (Check BASE_LISTING_URL and access)\n";
                  return [];
              }
          
              preg_match_all('/play\.php\?id=([a-fA-F0-9]+)/', $html, $matches);
              $ids = array_unique($matches[1]);
              echo "[INFO] Found " . count($ids) . " IDs\n";
              
              if (count($ids) === 0) {
                  echo "[WARN] Regex did not match any IDs. Listing page structure may have changed.\n";
              }
              
              return $ids;
          }
          
          function save_json($data) {
              // Ensure we save an empty JSON object {} if no data was processed, not an empty array [].
              if (empty($data) && is_array($data)) {
                  $json_to_save = json_encode(new \stdClass(), JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES);
                  echo "[WARN] Saving empty data as JSON object: {}\n";
              } else {
                  $json_to_save = json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES);
                  echo "[INFO] Saved api_data.json with " . count($data) . " entries.\n";
              }
              file_put_contents("api_data.json", $json_to_save);
          }
          
          $base_listing = getenv("BASE_LISTING_URL");
          $base_stream = getenv("BASE_STREAM_URL");
          
          if (!$base_listing || !$base_stream) {
              echo "[ERROR] Missing BASE_LISTING_URL or BASE_STREAM_URL secrets.\n";
              exit(1);
          }
          
          $data = [];
          if (file_exists("api_data.json")) {
              // Decode existing data as associative array
              $data = json_decode(file_get_contents("api_data.json"), true) ?: [];
          }
          
          $ids = get_channel_ids($base_listing);
          
          if (empty($ids)) {
              echo "[FATAL] Script ending early: No IDs found to process.\n";
              save_json($data); 
              exit;
          }

          $updated_count = 0;
          foreach ($ids as $id) {
              $info = fetch_and_decrypt_stream_info($base_stream . $id, $id);
              if ($info) {
                $data[$id] = $info;
                $updated_count++;
              }
          }
          
          echo "[SUMMARY] Successfully processed $updated_count streams out of " . count($ids) . " IDs found.\n";
          
          save_json($data);
          ?>
          PHP

      - name: Commit and push if changed
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          # '|| true' allows this step to succeed even if the file isn't found initially
          git add api_data.json || true
          # Check if there are staged changes; if so, commit and push
          git diff --staged --quiet || (git commit -m "Auto update API data (PHP)" && git push)
