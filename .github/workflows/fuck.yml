name: Auto Update Stream API (Node.js)

on:
  schedule:
    - cron: "*/20 * * * *"   
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-api:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          npm install axios jsdom

      - name: Run scraper
        env:
          BASE_LISTING_URL: ${{ secrets.BASE_LISTING_URL }}
          BASE_STREAM_URL: ${{ secrets.BASE_STREAM_URL }}
        run: |
          node <<'JS'
import axios from "axios";
import { JSDOM } from "jsdom";
import fs from "fs";

async function xorDecrypt(dataBase64, key) {
  const decoded = Buffer.from(dataBase64, "base64");
  const keyChars = key.split("").map((c) => c.charCodeAt(0));
  const output = decoded.map((b, i) => b ^ keyChars[i % keyChars.length]);
  return Buffer.from(output).toString("utf8");
}

async function fetchAndDecryptStreamInfo(url, contentId) {
  console.log(`â†’ Processing ID: ${contentId}`);
  try {
    const { data: html } = await axios.get(url, {
      headers: { "User-Agent": "Mozilla/5.0" },
      timeout: 12000,
    });

    const keyMatch = html.match(/const decryptionKey = "(.*?)";/);
    const encMatch = html.match(/let encrypted = "(.*?)";/);

    if (!keyMatch || !encMatch) {
      console.log("  [WARN] Missing key/encrypted data");
      return null;
    }

    const decrypted = await xorDecrypt(encMatch[1], keyMatch[1]);
    const mpd = decrypted.match(/const mpdUrl = '(.*?)';/);
    const kid = decrypted.match(/const kid = '(.*?)';/);
    const keyv = decrypted.match(/const key = '(.*?)';/);

    if (!mpd || !kid || !keyv) {
      console.log("  [WARN] Missing mpd/kid/key info");
      return null;
    }

    return { mpdUrl: mpd[1], kid: kid[1], key: keyv[1] };
  } catch (err) {
    console.log("  [ERROR]", err.message);
    return null;
  }
}

async function getChannelIds(listingUrl) {
  console.log("[INFO] Fetching listing:", listingUrl);
  try {
    const { data } = await axios.get(listingUrl, {
      headers: { "User-Agent": "Mozilla/5.0" },
      timeout: 15000,
    });
    const dom = new JSDOM(data);
    const links = [...dom.window.document.querySelectorAll('div.channel a[href*="play.php?id="]')];
    const ids = new Set();
    links.forEach((a) => {
      const m = a.href.match(/id=([a-fA-F0-9]+)/);
      if (m) ids.add(m[1]);
    });
    console.log(`[INFO] Found ${ids.size} IDs`);
    return [...ids];
  } catch (e) {
    console.log("[FATAL] Listing fetch failed:", e.message);
    return [];
  }
}

async function main() {
  const baseListing = process.env.BASE_LISTING_URL;
  const baseStream = process.env.BASE_STREAM_URL;

  const ids = await getChannelIds(baseListing);
  if (ids.length === 0) return console.log("[WARN] No IDs found.");

  let data = {};
  try {
    data = JSON.parse(fs.readFileSync("api_data.json", "utf8"));
  } catch {
    data = {};
  }

  for (const id of ids) {
    const info = await fetchAndDecryptStreamInfo(`${baseStream}${id}`, id);
    if (info) data[id] = info;
  }

  fs.writeFileSync("api_data.json", JSON.stringify(data, null, 4));
  console.log("[INFO] Saved api_data.json");
}

await main();
JS

      - name: Commit and push if changed
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add api_data.json || true
          git diff --staged --quiet || (git commit -m "Auto update API data" && git push)
